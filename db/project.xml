<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xmlns:pro="http://www.liquibase.org/xml/ns/pro"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd
						http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-4.1.xsd
						http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">
	<changeSet author="michael.franklin" id="2021-08-12-dbrefactor">

		<!-- Project settings -->
		<createTable tableName="project">
			<column name="id" type="INT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="VARCHAR(64)">
				<constraints unique="true" nullable="false" />
			</column>
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>

		</createTable>

		<!-- Participants -->
		<createTable tableName="participant">
			<column name="id" type="INT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="external_id" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="project" type="INT">
				<constraints nullable="false" foreignKeyName="fk_project_participant"
					references="project(id)" />
			</column>
			<!-- Record keeping -->
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addUniqueConstraint
			columnNames="project,external_id"
			tableName="participant"
			constraintName="UK_PARTICIPANT_SAMPLE_EXTERNALID"
			validate="true"
		/>
		<!-- Samples -->
		<createTable tableName="sample">
			<column name="id" type="INT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="external_id" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="project" type="INT">
				<constraints nullable="false" foreignKeyName="fk_project_sample"
					references="project(id)" />
			</column>
			<column name="participant_id" type="INT">
				<constraints nullable="true" foreignKeyName="fk_participant_sample"
					references="participant(id)" />
			</column>
			<column name="active" type="BOOLEAN" />
			<column name="meta" type="JSON" />
			<column name="type" type="ENUM('blood', 'saliva')" />

			<!-- Record keeping -->
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addUniqueConstraint
			columnNames="project,external_id"
			tableName="sample"
			constraintName="UK_SAMPLE_PROJECT_EXTERNALID"
			validate="true"
		/>

		<!-- Sample Sequencing  -->
		<createTable tableName="sample_sequencing">
			<column name="id" type="INT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="sample_id" type="INT">
				<constraints nullable="false" foreignKeyName="fk_sample_sequencing"
					references="sample(id)" />
			</column>
			<column name="type" type="ENUM('wgs', 'single-cell')">
				<constraints nullable="true" />
			</column>
			<column name="status"
				type="ENUM('unknown', 'received', 'sent-to-sequencing', 'completed-sequencing', 'completed-qc', 'failed-qc', 'uploaded')">
				<constraints nullable="false" />
			</column>
			<column name="meta" type="json" />
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<!-- Participant Phenotype -->
		<createTable tableName="participant_phenotypes">
			<column name="participant_id" type="INT" autoIncrement="true">
				<constraints nullable="false" foreignKeyName="fk_participant_phenotype"
					references="participant(id)" />
			</column>
			<column name="hpo_term" type="VARCHAR(255)">
				<constraints nullable="true" />
			</column>
			<column name="description" type="TEXT">
				<constraints nullable="true" />
			</column>

			<!-- Record keeping -->
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>
		<!-- <sql>ALTER TABLE participant_phenotypes ADD CONSTRAINT check_description_or_hpo CHECK
		(hpo_term IS NOT NULL or description IS NOT NULL)</sql> -->

		<!-- Analysis -->
		<createTable tableName="analysis">
			<column name="id" type="INT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="type" type="ENUM('qc', 'joint-calling', 'custom', 'gvcf', 'cram')">
				<constraints nullable="false" />
			</column>
			<column name="output" type="TEXT">
				<constraints nullable="true" />
			</column>
			<column name="status" type="ENUM('queued', 'in-progress', 'failed', 'completed')">
				<constraints nullable="false" />
			</column>
			<column name="timestamp_completed" type="timestamp" />

			<column name="project" type="INT">
				<constraints nullable="false" foreignKeyName="fk_project_analysis"
					references="project(id)" />
			</column>
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>

		</createTable>

		<createTable tableName="analysis_sample">
			<column name="analysis_id" type="INT">
				<constraints nullable="false" foreignKeyName="fk_analysis_sample"
					references="analysis(id)" />
			</column>
			<column name="sample_id" type="INT">
				<constraints nullable="false" foreignKeyName="fk_analysis_sample_sample"
					references="sample(id)" />
			</column>

		</createTable>

		<!-- Family -->
		<createTable tableName="family">
			<column name="id" type="INT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="external_id" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="project" type="INT">
				<constraints nullable="false" foreignKeyName="fk_project_family"
					references="project(id)" />
			</column>
			<column name="description" type="TEXT">
				<constraints nullable="true" />
			</column>
			<column name="coded_phenotype" type="VARCHAR(255)">
				<constraints nullable="true" />
			</column>
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addUniqueConstraint
			columnNames="project,external_id"
			tableName="family"
			constraintName="UK_FAMILY_PROJECT_EXTERNALID"
			validate="true"
		/>
		<createTable tableName="family_participant">
			<column name="family_id" type="INT">
				<constraints nullable="false" foreignKeyName="fk_family_participant"
					references="family(id)" />
			</column>
			<column name="participant_id" type="INT">
				<constraints nullable="false" foreignKeyName="fk_family_participant_participant"
					references="participant(id)" />
			</column>
			<column name="paternal_participant_id" type="INT">
				<constraints nullable="true" foreignKeyName="fk_family_participant_paternal"
					references="participant(id)" />
			</column>
			<column name="maternal_participant_id" type="INT">
				<constraints nullable="true" foreignKeyName="fk_family_participant_maternal"
					references="participant(id)" />
			</column>
			<column name="sex" type="INT">
				<constraints nullable="true" />
			</column>
			<column name="affected" type="INT">
				<constraints nullable="true" />
			</column>
			<column name="notes" type="TEXT">
				<constraints nullable="true" />
			</column>
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>

		</createTable>

		<sql>ALTER TABLE project ADD SYSTEM VERSIONING;</sql>
		<sql>ALTER TABLE participant ADD SYSTEM VERSIONING;</sql>
		<sql>ALTER TABLE sample ADD SYSTEM VERSIONING;</sql>
		<sql>ALTER TABLE sample_sequencing ADD SYSTEM VERSIONING;</sql>
		<sql>ALTER TABLE participant_phenotypes ADD SYSTEM VERSIONING;</sql>
		<sql>ALTER TABLE analysis ADD SYSTEM VERSIONING;</sql>
		<sql>ALTER TABLE analysis_sample ADD SYSTEM VERSIONING;</sql>
		<sql>ALTER TABLE family ADD SYSTEM VERSIONING;</sql>
		<sql>ALTER TABLE family_participant ADD SYSTEM VERSIONING;</sql>
	</changeSet>
	<changeSet author="michael.franklin" id="2021-08-24_add-participant-key-value">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<dropForeignKeyConstraint baseTableName="participant_phenotypes"
			constraintName="fk_participant_phenotype" />
		<sql>ALTER TABLE participant_phenotypes CHANGE participant_id participant_id INT NOT NULL;</sql>
		<sql>ALTER TABLE participant_phenotypes CHANGE description description VARCHAR(255);</sql>

		<addPrimaryKey
			tableName="family_participant"
			columnNames="participant_id"
		/>
		<sql> ALTER TABLE participant_phenotypes ADD CONSTRAINT
			uk_participant_phenotypes_pid_hpo_description UNIQUE
			(`participant_id`,`hpo_term`,`description`) </sql>
		<addForeignKeyConstraint
			constraintName="fk_participant_phenotype"
			baseTableName="participant_phenotypes"
			baseColumnNames="participant_id"
			referencedTableName="participant"
			referencedColumnNames="id"
		/>
		<addColumn
			tableName="participant_phenotypes">
			<column
				name="value"
				type="JSON"
			/>
		</addColumn>

	</changeSet>
	<changeSet author="michael.franklin" id="2021-08-16_add-project-id">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<addColumn
			tableName="project">
			<column
				name="dataset"
				type="VARCHAR(255)"
			/>
			<column
				name="gcp_id"
				type="VARCHAR(255)"
			/>
			<column
				name="read_secret_name"
				type="VARCHAR(255)"
			/>
			<column
				name="write_secret_name"
				type="VARCHAR(255)"
			/>
		</addColumn>
	</changeSet>
	<changeSet author="michael.franklin" id="2021-09-13_add-analysis-improvements">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<addColumn
			tableName="analysis">
			<column
				name="meta"
				type="JSON"
				defaultValue="{}"
			/>
			<column
				name="active"
				type="BIT NOT NULL"
				defaultValue="1"
			/>
			<column
				name="on_behalf_of"
				type="VARCHAR(255)"
			/>
		</addColumn>
		<sql>ALTER TABLE analysis MODIFY COLUMN status ENUM('queued', 'in-progress', 'failed',
			'completed', 'unknown');</sql>

	</changeSet>
	<changeSet author="michael.franklin" id="2021-09-14_add-exome-sequence-type">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<sql>ALTER TABLE sample_sequencing MODIFY COLUMN type ENUM('wgs', 'single-cell', 'exome');</sql>
	</changeSet>
	<changeSet author="michael.franklin" id="2021-11-01_sex-clarification">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<addColumn
			tableName="participant">
			<column
				name="reported_sex"
				type="int"
			/>
			<column
				name="reported_gender"
				type="VARCHAR(255)"
			/>
			<column
				name="karyotype"
				type="VARCHAR(255)"
			/>
			<column
				name="meta"
				type="json"
				defaultValue="{}"
			/>
		</addColumn>
		<sql> UPDATE participant p, family_participant fp SET p.reported_sex = fp.sex,
			p.author="michael.franklin@populationgenomics.org.au" WHERE p.id = fp.participant_id; </sql>
		<dropColumn
			tableName="family_participant"
			columnName="sex"
		/>
	</changeSet>
	<changeSet author="michael.franklin" id="2022-01-19_expand-family-coded-phenotype-column">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<sql>ALTER TABLE family MODIFY COLUMN coded_phenotype TEXT;</sql>
	</changeSet>
	<changeSet author="sabrina.yan" id="2022-03-07_standardise-sequence-type">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<!-- True values 'genome', 'exome', 'single-cell' but maintaining old 'wgs' for system
		version tables -->
		<sql>ALTER TABLE sample_sequencing MODIFY COLUMN type ENUM('genome', 'exome', 'single-cell',
			'wgs');</sql>
		<sql> UPDATE sample_sequencing seq SET seq.type = 'genome',
			seq.author="sabrina.yan@populationgenomics.org.au" WHERE seq.type = 'wgs'; </sql>
	</changeSet>
	<changeSet author="sabrina.yan" id="2022-05-03_add-mtseq-sequence-type">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<!-- True values 'genome', 'exome', 'single-cell' and now 'mtseq' but maintaining old 'wgs'
		for system version tables -->
		<sql>ALTER TABLE sample_sequencing MODIFY COLUMN type ENUM('genome', 'exome', 'single-cell',
			'mtseq', 'wgs');</sql>
	</changeSet>
	<changeSet author="michael.franklin" id="2022-05-18_add-es-index-ont-project.meta">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<!-- True values 'genome', 'exome', 'single-cell', 'mtseq' and 'ont' but maintaining old
		'wgs' for system version tables -->
		<sql>ALTER TABLE sample_sequencing MODIFY COLUMN type ENUM('genome', 'exome', 'single-cell',
			'mtseq', 'ont', 'wgs');</sql>
		<sql>ALTER TABLE analysis MODIFY COLUMN type ENUM('qc', 'joint-calling', 'custom', 'gvcf',
			'cram', 'es-index');</sql>
		<addColumn
			tableName="project">
			<column
				name="meta"
				type="JSON"
			/>
		</addColumn>
	</changeSet>
	<changeSet author="vivian.bakiris" id="2022-08-22_add-sv-analysis-type">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<sql>ALTER TABLE analysis MODIFY COLUMN type ENUM('qc', 'joint-calling', 'custom', 'gvcf',
			'cram', 'es-index', 'sv');</sql>
	</changeSet>
	<changeSet author="michael.franklin" id="2022-10-04_sequence-external-ids">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<createTable tableName="sample_sequencing_eid">
			<column name="project" type="INT">
				<constraints nullable="false" foreignKeyName="fk_sample_sequencing_eid_project"
					references="project(id)" />
			</column>
			<column name="sequencing_id" type="INT">
				<constraints nullable="false" foreignKeyName="fk_sample_sequencing_eid_sequence_id"
					references="sample_sequencing(id)" />
			</column>
			<column name="external_id" type="VARCHAR(255)">
				<constraints unique="true" nullable="false" />
			</column>
			<column name="name" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>

		</createTable>
		<addPrimaryKey
			columnNames="sequencing_id,name"
			constraintName="PK_sample_sequencing_eid"
			tableName="sample_sequencing_eid"
			validate="true"
		/>
		<addUniqueConstraint
			columnNames="project,external_id"
			tableName="participant"
			constraintName="UK_SAMPLE_SEQUENCING_EXTERNALID"
			validate="true"
		/>
	</changeSet>
	<changeSet author="michael.franklin" id="2022-10-25_sequence-external-ids-correction">
		<sql>ALTER TABLE sample_sequencing_eid ADD SYSTEM VERSIONING;</sql>

	</changeSet>
	<changeSet author="michael.franklin" id="2022-12-01_sequence-external-ids-pk-correction">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<dropUniqueConstraint
			tableName="sample_sequencing_eid"
			constraintName="external_id"
		/>
		<!--		This was incorrect named, so delete and create on correct table -->
		<dropUniqueConstraint
			tableName="participant"
			constraintName="UK_SAMPLE_SEQUENCING_EXTERNALID"
		/>
		<addUniqueConstraint
			columnNames="project,external_id"
			tableName="sample_sequencing_eid"
			constraintName="UK_SAMPLE_SEQUENCING_EXTERNALID"
			validate="true"
		/>
	</changeSet>
	<changeSet author="michael.franklin" id="2022-12-12_more-analysis-types">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<sql>ALTER TABLE analysis MODIFY COLUMN type ENUM('qc', 'joint-calling', 'custom', 'gvcf',
			'cram', 'es-index', 'sv', 'web', 'analysis-runner');</sql>
		<sql>UPDATE analysis SET type = 'analysis-runner' WHERE type='custom' AND json_extract(meta,
			'$.source') = 'analysis-runner';</sql>
	</changeSet>
	<changeSet author="michael.franklin" id="2022-11-23_sequencing-technology">
		<sql>SET @@system_versioning_alter_history = 1;</sql>

		<addColumn
			tableName="sample_sequencing">
			<column
				name="technology"
				type="ENUM('short-read', 'long-read', 'single-cell-rna-seq', 'bulk-rna-seq')"
			/>
		</addColumn>
		<sql> ALTER TABLE sample_sequencing MODIFY COLUMN type ENUM('genome', 'exome',
			'single-cell', 'mtseq', 'ont', 'wgs', 'transcriptome', 'chip'); UPDATE sample_sequencing
			SET technology = 'short-read' WHERE type = 'genome' or type = 'exome' or type = 'mtseq';
			UPDATE sample_sequencing SET type = 'genome', technology = 'long-read',
			meta=JSON_MERGE(meta, '{"source": "ont"}') WHERE type = 'ont'; UPDATE sample_sequencing
			SET type = 'transcriptome', technology = 'single-cell-rna-seq' WHERE type =
			'single-cell'; </sql>
	</changeSet>
	<changeSet author="michael.franklin" id="2023-01-25_">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<renameColumn
			columnDataType="VARCHAR(255)"
			newColumnName="read_group_name"
			oldColumnName="read_secret_name"
			remarks="Migration of groups membership cache to blobs"
			tableName="project"
		/>
		<renameColumn
			columnDataType="VARCHAR(255)"
			newColumnName="write_group_name"
			oldColumnName="write_secret_name"
			remarks="Migration of groups membership cache to blobs"
			tableName="project"
		/>
		<dropColumn
			tableName="project"
			columnName="gcp_id"
		/>
		<sql> UPDATE project SET read_group_name=SUBSTRING(read_group_name, 1,
			LENGTH(read_group_name) - 14), write_group_name=SUBSTRING(write_group_name, 1,
			LENGTH(write_group_name) - 14) </sql>
	</changeSet>

	<changeSet author="michael.franklin" id="2022-12-13_sequence-groups">
		<sql>SET @@system_versioning_alter_history = 1;</sql>

		<!--		Instead of ENUMs, make some fields FKs -->
		<createTable tableName="assay_type">
			<column name="id" type="VARCHAR(255)">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="sequencing_technology">
			<column name="id" type="VARCHAR(255)">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="sequencing_type">
			<column name="id" type="VARCHAR(255)">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="sequencing_platform">
			<column name="id" type="VARCHAR(255)">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="sample_type">
			<column name="id" type="VARCHAR(255)">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="analysis_type">
			<column name="id" type="VARCHAR(255)">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<!--		Create assay table linking to assay_type FK-->
		<createTable tableName="assay">
			<column name="id" type="INT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="sample_id" type="INT">
				<constraints nullable="false" foreignKeyName="FK_SAMPLE_ASSAY"
					references="sample(id)" />
			</column>
			<column name="type" type="VARCHAR(255)">
				<constraints nullable="false" foreignKeyName="FK_ASSAY_TYPE"
					references="assay_type(id)" />
			</column>
			<column name="meta" type="json" />
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="assay_external_id">
			<column name="project" type="INT">
				<constraints nullable="false" foreignKeyName="FK_ASSAY_EXTERNAL_ID_PROJECT"
					references="project(id)" />
			</column>
			<column name="assay_id" type="INT">
				<constraints nullable="false" foreignKeyName="FK_ASSAY_EXTERNAL_ID_ASSAY"
					references="assay(id)" />
			</column>
			<column name="external_id" type="VARCHAR(255)">
				<constraints unique="true" nullable="false" />
			</column>
			<column name="name" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>

		</createTable>
		<addPrimaryKey
			columnNames="assay_id,name"
			constraintName="PK_ASSAY_EXTERNAL_ID"
			tableName="assay_external_id"
			validate="true"
		/>
		<addUniqueConstraint
			columnNames="project,external_id"
			tableName="assay_external_id"
			constraintName="UK_PROJECT_ASSAY_EXTERNAL_ID"
			validate="true"
		/>

		<!--		Create sequencing_group tables -->
		<createTable tableName="sequencing_group">
			<column name="id" type="INT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<!--			<column name="project" type="INT">-->
			<!--				<constraints nullable="false" foreignKeyName="fk_sequencing_group_project"
			references="project(id)" />-->
			<!--			</column>-->
			<column name="sample_id" type="INT">
				<constraints nullable="false" foreignKeyName="fk_sequencing_group_sample"
					references="sample(id)" />
			</column>
			<column name="type" type="VARCHAR(255)">
				<constraints nullable="false" foreignKeyName="fk_sqg_sequencing_type"
					references="sequencing_type(id)" />
			</column>
			<column name="technology" type="VARCHAR(255)">
				<constraints nullable="false" foreignKeyName="fk_sqg_sequencing_technology"
					references="sequencing_technology(id)" />
			</column>
			<column name="platform" type="VARCHAR(255)">
				<!--				<constraints nullable="true" foreignKeyName="fk_sqg_sequencing_platform"
				references="sequencing_platform(id)"/>-->
			</column>
			<column name="meta" type="JSON" />
			<column name="archived" type="BOOLEAN" />
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="sequencing_group_assay">
			<column name="sequencing_group_id" type="INT">
				<constraints nullable="false" foreignKeyName="fk_sqg_sequencing_group_id"
					references="sequencing_group(id)" />
			</column>
			<column name="assay_id" type="INT">
				<constraints nullable="false" foreignKeyName="fk_sqg_sequencing_group_sequence_id"
					references="assay(id)" />
			</column>
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<!--		In MariaDB, you can do _conditional_ unique values in a sort of hacky way.
			You make a combined key, with one of the fields only NOT NULL when the row should participant in
		the check.
			IE: if you archive a sequencing group, marking the "nullIfInactitve field to NULL will allow
		multiple
			copies - allowing for us to reuse the same external_ids for multiple sequencing groups. 	-->
		<createTable tableName="sequencing_group_external_id">
			<column name="project" type="INT">
				<constraints nullable="false" foreignKeyName="fk_sequencing_group_eid_project"
					references="project(id)" />
			</column>
			<column name="sequencing_group_id" type="INT">
				<constraints nullable="false"
					foreignKeyName="fk_sequencing_group_eid_sequencing_group_id"
					references="sequencing_group(id)" />
			</column>
			<column name="external_id" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="name" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="nullIfInactive" type="BIT" defaultValue="true">
				<constraints nullable="true" />
			</column>
		</createTable>
		<addUniqueConstraint
			columnNames="project,external_id,nullIfInactive"
			tableName="sequencing_group_external_id"
			constraintName="UK_SEQUENCING_GROUP_EXTERNALID"
			validate="true"
		/>

		<!-- 		Replaces the analysis_sample table.
			We cannot delete the old table, so it's around for legacy purposes. -->
		<createTable tableName="analysis_sequencing_group">
			<column name="analysis_id" type="INT">
				<constraints
					nullable="false"
					foreignKeyName="FK_ANALYSIS_SQG_ANALYSIS"
					references="analysis(id)" />
			</column>
			<column name="sequencing_group_id" type="INT">
				<constraints
					nullable="false"
					foreignKeyName="FK_ANALYSIS_SQG_SEQUENCING_GROUP"
					references="sequencing_group(id)"
				/>
			</column>
		</createTable>


		<!--		Default data -->

		<sql> ALTER TABLE assay ADD SYSTEM VERSIONING; ALTER TABLE assay_external_id ADD SYSTEM
			VERSIONING; ALTER TABLE sequencing_group ADD SYSTEM VERSIONING; ALTER TABLE
			sequencing_group_assay ADD SYSTEM VERSIONING; ALTER TABLE sequencing_group_external_id
			ADD SYSTEM VERSIONING; ALTER TABLE analysis_sequencing_group ADD SYSTEM VERSIONING;
			INSERT INTO assay_type (id, name) VALUES ('sequencing', 'sequencing'); INSERT INTO
			sample_type (id, name) VALUES ('blood', 'blood'); INSERT INTO sample_type (id, name)
			VALUES ('saliva', 'saliva'); INSERT INTO sequencing_type (id, name) VALUES ('genome',
			'genome'); INSERT INTO sequencing_type (id, name) VALUES ('exome', 'exome'); INSERT INTO
			sequencing_type (id, name) VALUES ('transcriptome', 'transcriptome'); INSERT INTO
			sequencing_type (id, name) VALUES ('mtseq', 'mtseq'); INSERT INTO sequencing_type (id,
			name) VALUES ('chip', 'chip'); INSERT INTO sequencing_technology (id, name) VALUES
			('short-read', 'short-read'); INSERT INTO sequencing_technology (id, name) VALUES
			('long-read', 'long-read'); INSERT INTO sequencing_technology (id, name) VALUES
			('single-cell-rna-seq', 'single-cell-rna-seq'); INSERT INTO sequencing_technology (id,
			name) VALUES ('bulk-rna-seq', 'bulk-rna-seq'); INSERT INTO sequencing_platform (id,
			name) VALUES ('illumina', 'illumina'); INSERT INTO sequencing_platform (id, name) VALUES
			('pacbio', 'pacbio'); INSERT INTO sequencing_platform (id, name) VALUES
			('oxford-nanopore', 'oxford-nanopore'); INSERT INTO analysis_type (id, name) VALUES
			('qc', 'qc'); INSERT INTO analysis_type (id, name) VALUES ('joint-calling',
			'joint-calling'); INSERT INTO analysis_type (id, name) VALUES ('gvcf', 'gvcf'); INSERT
			INTO analysis_type (id, name) VALUES ('cram', 'cram'); INSERT INTO analysis_type (id,
			name) VALUES ('custom', 'custom'); INSERT INTO analysis_type (id, name) VALUES
			('es-index', 'es-index'); INSERT INTO analysis_type (id, name) VALUES ('sv', 'sv');
			INSERT INTO analysis_type (id, name) VALUES ('web', 'web'); INSERT INTO analysis_type
			(id, name) VALUES ('analysis-runner', 'analysis-runner'); </sql>
	</changeSet>
	<changeSet id="2023-06-20_cohort-builder" author="michael.franklin">
		<createTable tableName="cohort">
			<column name="id" type="INT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="derived_from" type="INT">
				<constraints
					nullable="false"
					foreignKeyName="FK_COHORT_DERIVED_FROM_ID_COHORT"
					references="cohort(id)"
				/>
			</column>
			<column name="description" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="timestamp" type="TIMESTAMP">
				<constraints nullable="false" />
			</column>
		</createTable>
		<!--		How SGs belong to a cohort -->
		<createTable tableName="cohort_sequencing_group">
			<column name="cohort_id" type="INT">
				<constraints nullable="false" foreignKeyName="FK_COHORT_SQG_COHORT_ID"
					references="cohort(id)" />
			</column>
			<column name="sequencing_group_id" type="INT">
				<constraints nullable="false" foreignKeyName="FK_COHORT_SQG_SQG_ID"
					references="sequencing_group(id)" />
			</column>
		</createTable>
		<!--		Linking cohort to an analysis -->
		<createTable tableName="analysis_cohort">
			<column name="cohort_id" type="INT">
				<constraints nullable="false" foreignKeyName="FK_COHORT_ANALYSIS_COHORT_ID"
					references="cohort(id)" />
			</column>
			<column name="analysis_id" type="INT">
				<constraints nullable="false" foreignKeyName="FK_COHORT_ANALYSIS_SQG_ID"
					references="analysis(id)" />
			</column>
		</createTable>
	</changeSet>
	<changeSet id="2023-10-04_sample-type" author="michael.franklin">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<!-- change the sample.type field from an enum, to reference sample_type.id -->
		<sql>ALTER TABLE sample MODIFY COLUMN type VARCHAR(255);</sql>
		<addForeignKeyConstraint
			constraintName="FK_SAMPLE_SAMPLE_TYPE"
			baseTableName="sample"
			baseColumnNames="type"
			referencedTableName="sample_type"
			referencedColumnNames="id"
		/>
	</changeSet>
	<changeSet id="2023-10-20-analysis-type" author="michael.franklin">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<!-- change the sample.type field from an enum, to reference sample_type.id -->
		<sql>ALTER TABLE analysis MODIFY COLUMN type VARCHAR(255);</sql>
		<addForeignKeyConstraint
			constraintName="FK_ANALYSIS_ANALYSIS_TYPE"
			baseTableName="analysis"
			baseColumnNames="type"
			referencedTableName="analysis_type"
			referencedColumnNames="id"
		/>
	</changeSet>

	<changeSet id="2023-10-06_inbuilt-permissions" author="michael.franklin">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<createTable tableName="group">
			<column name="id" type="INT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="VARCHAR(255)">
				<constraints unique="true" nullable="false" />
			</column>
		</createTable>
		<createTable tableName="group_member">
			<column name="group_id" type="INT">
				<constraints
					nullable="false"
					foreignKeyName="FK_GROUP_MEMBER_GROUP_ID"
					references="group(id)" />
			</column>
			<column name="member" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addColumn
			tableName="project">
			<column
				name="read_group_id"
				type="INT"
			>
				<constraints
					nullable="true"
					foreignKeyName="FK_PROJECT_READ_GROUP_GROUP_ID"
					references="group(id)" />
			</column>
			<column
				name="write_group_id"
				type="INT"
			>
				<constraints
					nullable="true"
					foreignKeyName="FK_PROJECT_WRITE_GROUP_GROUP_ID"
					references="group(id)" />
			</column>
		</addColumn>
		<sql>ALTER TABLE `group` ADD SYSTEM VERSIONING;</sql>
		<sql>ALTER TABLE group_member ADD SYSTEM VERSIONING;</sql>
		<sql>INSERT INTO `group` (name) VALUES ('project-creators');</sql>
		<sql>INSERT INTO `group` (name) VALUES ('members-admin');</sql>
	</changeSet>
	<changeSet id="2023-11-03_audit_log" author="michael.franklin">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<createTable tableName="audit_log">
			<column name="id" type="INT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="timestamp" type="TIMESTAMP" defaultValue="now()">
				<constraints nullable="false" />
			</column>
			<column name="author" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="on_behalf_of" type="VARCHAR(255)">
				<constraints nullable="true" />
			</column>
			<column name="ar_guid" type="VARCHAR(255)">
				<constraints nullable="true" />
			</column>
			<column name="comment" type="TEXT">
				<constraints nullable="true" />
			</column>
			<column name="auth_project" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_AUDIT_LOG_PROJECT"
					references="project(id)" />
			</column>
			<column name="meta" type="JSON" />
		</createTable>
		<sql>ALTER TABLE `audit_log` ADD SYSTEM VERSIONING;</sql>

		<addColumn tableName="analysis">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_ANALYSIS_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="analysis_cohort">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_ANALYSIS_COHORT_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="analysis_sample">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_ANALYSIS_SAMPLE_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="analysis_sequencing_group">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_ANALYSIS_SEQUENCING_GROUP_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="analysis_type">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_ANALYSIS_TYPE_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="assay">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_ASSAY_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="assay_external_id">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_ASSAY_EXTERNAL_ID_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="assay_type">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_ASSAY_TYPE_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="cohort">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_COHORT_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="cohort_sequencing_group">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_COHORT_SEQUENCING_GROUP_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="family">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_FAMILY_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="family_participant">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_FAMILY_PARTICIPANT_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="group">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_GROUP_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="group_member">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_GROUP_MEMBER_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="participant">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_PARTICIPANT_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="participant_phenotypes">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_PARTICIPANT_PHENOTYPES_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="project">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_PROJECT_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="sample">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_SAMPLE_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="sample_sequencing">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_SAMPLE_SEQUENCING_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="sample_sequencing_eid">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_SAMPLE_SEQUENCING_EID_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="sample_type">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_SAMPLE_TYPE_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="sequencing_group">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_SEQUENCING_GROUP_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="sequencing_group_assay">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_SEQUENCING_GROUP_ASSAY_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="sequencing_group_external_id">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_SEQUENCING_GROUP_EXTERNAL_ID_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="sequencing_platform">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_SEQUENCING_PLATFORM_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="sequencing_technology">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_SEQUENCING_TECHNOLOGY_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<addColumn tableName="sequencing_type">
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="true"
					foreignKeyName="FK_SEQUENCING_TYPE_CHANGELOG_ID"
					references="audit_log(id)" />
			</column>
		</addColumn>
		<sql>ALTER TABLE analysis CHANGE author author VARCHAR(255) NULL;</sql>
		<sql>ALTER TABLE assay CHANGE author author VARCHAR(255) NULL;</sql>
		<sql>ALTER TABLE assay_external_id CHANGE author author VARCHAR(255) NULL;</sql>
		<sql>ALTER TABLE cohort CHANGE author author VARCHAR(255) NULL;</sql>
		<sql>ALTER TABLE family CHANGE author author VARCHAR(255) NULL;</sql>
		<sql>ALTER TABLE family_participant CHANGE author author VARCHAR(255) NULL;</sql>
		<sql>ALTER TABLE group_member CHANGE author author VARCHAR(255) NULL DEFAULT NULL;</sql>
		<sql>ALTER TABLE participant CHANGE author author VARCHAR(255) NULL;</sql>
		<sql>ALTER TABLE participant_phenotypes CHANGE author author VARCHAR(255) NULL;</sql>
		<sql>ALTER TABLE project CHANGE author author VARCHAR(255) NULL;</sql>
		<sql>ALTER TABLE sample CHANGE author author VARCHAR(255) NULL;</sql>
		<sql>ALTER TABLE sample_sequencing CHANGE author author VARCHAR(255) NULL;</sql>
		<sql>ALTER TABLE sample_sequencing_eid CHANGE author author VARCHAR(255) NULL;</sql>
		<sql>ALTER TABLE sequencing_group CHANGE author author VARCHAR(255) NULL;</sql>
		<sql>ALTER TABLE sequencing_group_assay CHANGE author author VARCHAR(255) NULL;</sql>
		<sql>ALTER TABLE sequencing_group_external_id CHANGE author author VARCHAR(255) NULL;</sql>
	</changeSet>
	<changeSet id="2024-02-27_analysis-runner-table" author="michael.franklin">
		<sql>SET @@system_versioning_alter_history = 1;</sql>
		<createTable tableName="analysis_runner">
			<column name="ar_guid" type="VARCHAR(255)">
				<constraints nullable="false" unique="true" />
			</column>
			<column name="project" type="int">
				<constraints
					nullable="false"
					foreignKeyName="FK_AR_PROJECT"
					references="project(id)"
				/>

			</column>
			<column name="timestamp" type="timestamp" />
			<column name="access_level" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="repository" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="commit" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="output_path" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="script" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="driver_image" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="config_path" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="cwd" type="VARCHAR(255)">
				<constraints nullable="true" />
			</column>
			<column name="environment" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="hail_version" type="VARCHAR(255)">
				<constraints nullable="true" />
			</column>
			<column name="batch_url" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="submitting_user" type="VARCHAR(255)" />
			<column name="meta" type="JSON" />
			<column name="audit_log_id" type="INT">
				<constraints
					nullable="false"
					foreignKeyName="FK_ANALYSIS_RUNNER_CHANGELOG_ID"
					references="audit_log(id)"
				/>
			</column>
		</createTable>

		<createIndex indexName="idx_ar_guid" tableName="analysis_runner">
			<column name="ar_guid" />
		</createIndex>
		<createIndex tableName="analysis_runner" indexName="idx_ar_submitting_user">
			<column name="submitting_user" />
		</createIndex>
		<sql> ALTER TABLE analysis_runner ADD SYSTEM VERSIONING; </sql>
	</changeSet>
	<changeSet id="2024-03-15_analysis-runner-table-migration" author="michael.franklin">

	<!-- make the configPath nullable -->

	<sql>
	SET @@system_versioning_alter_history = 1;
	ALTER TABLE analysis_runner MODIFY COLUMN config_path VARCHAR(255) NULL;
	ALTER TABLE analysis_runner MODIFY COLUMN audit_log_id INT NULL;
	</sql>

	<!-- Migrate all the old analysis_runner records into the new table (don't delete existing ones for now) -->

		<sql> INSERT INTO analysis_runner ( ar_guid, project, timestamp, access_level, repository,
			`commit`, output_path, script, description, driver_image, config_path, cwd, environment,
			hail_version, batch_url, submitting_user, meta, audit_log_id ) SELECT
			COALESCE(JSON_UNQUOTE(JSON_EXTRACT(analysis.meta, '$.ar-guid')), UUID()) as ar_guid,
			analysis.project as project,
			STR_TO_DATE(REPLACE(JSON_UNQUOTE(JSON_EXTRACT(analysis.meta, '$.timestamp')), 'T', ' '),
			'%Y-%m-%d %H:%i:%s.%f') as timestamp, JSON_UNQUOTE(JSON_EXTRACT(analysis.meta,
			'$.accessLevel')) as access_level, JSON_UNQUOTE(JSON_EXTRACT(analysis.meta, '$.repo'))
			as repository, JSON_UNQUOTE(JSON_EXTRACT(analysis.meta, '$.commit')) as `commit`,
			analysis.output as output_path, JSON_UNQUOTE(JSON_EXTRACT(analysis.meta, '$.script')) as
			script, JSON_UNQUOTE(JSON_EXTRACT(analysis.meta, '$.description')) as description,
			JSON_UNQUOTE(JSON_EXTRACT(analysis.meta, '$.driverImage')) as driver_image,
			JSON_UNQUOTE(JSON_EXTRACT(analysis.meta, '$.configPath')) as config_path,
			JSON_UNQUOTE(JSON_EXTRACT(analysis.meta, '$.cwd')) as cwd,
			COALESCE(JSON_UNQUOTE(JSON_EXTRACT(analysis.meta, '$.environment')), 'gcp') as environment,
			JSON_UNQUOTE(JSON_EXTRACT(analysis.meta, '$.hailVersion')) as hail_version,
			JSON_UNQUOTE(JSON_EXTRACT(analysis.meta, '$.batch_url')) as batch_url,
			COALESCE(audit_log.on_behalf_of, analysis.author) as submitting_user, JSON_REMOVE(
			analysis.meta, '$.ar-guid', '$.timestamp', '$.accessLevel', '$.repo', '$.commit',
			'$.script', '$.description', '$.driverImage', '$.configPath', '$.cwd', '$.environment',
			'$.hailVersion', '$.batch_url' ) as meta, analysis.audit_log_id FROM analysis LEFT JOIN
			audit_log ON analysis.audit_log_id = audit_log.id WHERE analysis.type =
			"analysis-runner" </sql>

	</changeSet>
</databaseChangeLog>
